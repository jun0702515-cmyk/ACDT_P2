<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Korean Killer</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <script src="./edge-impulse-standalone.js"></script>

    <script>
      var Module = typeof Module !== 'undefined' ? Module : {};
      let classifierInitialized = false;
      Module.onRuntimeInitialized = function() { classifierInitialized = true; };

      class EdgeImpulseClassifier {
        constructor() { this._module = Module; }
        init() {
          if (classifierInitialized === true) return Promise.resolve();
          return new Promise((resolve, reject) => {
            if (!this._module || !this._module.onRuntimeInitialized) {
                if (window.Module) this._module = window.Module;
            }
            this._module.onRuntimeInitialized = () => {
              classifierInitialized = true;
              this._module.init();
              resolve();
            };
          });
        }
        classify(rawData, debug = false) {
          if (!classifierInitialized) throw new Error('Module is not initialized');
          if (!this._module._malloc && window.Module) { this._module = window.Module; }
          const obj = this._arrayToHeap(rawData);
          let ret = this._module.run_classifier(obj.buffer.byteOffset, rawData.length, debug);
          this._module._free(obj.ptr);
          if (ret.result !== 0) throw new Error('Classification failed');
          let jsResult = { results: [] };
          for (let cx = 0; cx < ret.size(); cx++) {
            let c = ret.get(cx);
            jsResult.results.push({ label: c.label, value: c.value });
            c.delete();
          }
          ret.delete();
          return jsResult;
        }
        _arrayToHeap(data) {
          let typedArray = new Float32Array(data);
          let numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
          let ptr = this._module._malloc(numBytes);
          let heapBytes = new Uint8Array(this._module.HEAPU8.buffer, ptr, numBytes);
          heapBytes.set(new Uint8Array(typedArray.buffer));
          return { ptr: ptr, buffer: heapBytes };
        }
      }
      window.EdgeImpulseClassifier = EdgeImpulseClassifier;
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./src/main.jsx"></script>
  </body>
</html>
